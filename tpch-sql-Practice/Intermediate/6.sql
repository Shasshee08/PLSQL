WITH CUSTOMER_REVENUE AS (
    SELECT
        C.C_CUSTKEY,
        C.C_NAME,
        N.N_NAME AS NATION_NAME,
        SUM(L.L_EXTENDEDPRICE * (1 - L.L_DISCOUNT)) AS TOTAL_REVENUE
    FROM
        CUSTOMER C
    JOIN
        ORDERS O ON C.C_CUSTKEY = O.O_CUSTKEY
    JOIN
        LINEITEM L ON O.O_ORDERKEY = L.L_ORDERKEY
    JOIN
        NATION N ON C.C_NATIONKEY = N.N_NATIONKEY
    GROUP BY
        C.C_CUSTKEY, C.C_NAME, N.N_NAME
)
SELECT
    C_NAME,
    NATION_NAME,
    TOTAL_REVENUE,
    RANK() OVER (PARTITION BY NATION_NAME ORDER BY TOTAL_REVENUE DESC) AS NATION_RANK
FROM
    CUSTOMER_REVENUE
ORDER BY
    NATION_NAME, NATION_RANK;
